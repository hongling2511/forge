# Quickstart: JWT Authentication

**Feature**: 004-jwt-auth
**Date**: 2026-01-05

## Overview

This guide shows how to test JWT authentication in a project generated by the java-ddd template.

## Prerequisites

- Java 17+
- Maven 3.6+
- curl or any REST client (Postman, Insomnia)

## Generate a Project

```bash
forge new -t java-ddd -g com.example -a auth-demo
cd auth-demo
```

## Build and Run

```bash
mvn clean install
cd auth-demo-bootstrap
mvn spring-boot:run
```

The application starts on `http://localhost:8080`.

## Test Authentication Flow

### 1. Register a New User

```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "johndoe",
    "email": "john@example.com",
    "password": "SecurePass123"
  }'
```

**Expected Response** (201 Created):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "username": "johndoe",
  "email": "john@example.com",
  "roles": ["USER"],
  "enabled": true,
  "createdAt": "2026-01-05T10:30:00Z"
}
```

### 2. Login

```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "password": "SecurePass123"
  }'
```

**Expected Response** (200 OK):
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
  "tokenType": "Bearer",
  "expiresIn": 900
}
```

Save the `accessToken` and `refreshToken` for subsequent requests.

### 3. Access Protected Endpoint

```bash
# Replace <ACCESS_TOKEN> with the token from login response
curl http://localhost:8080/api/protected/user \
  -H "Authorization: Bearer <ACCESS_TOKEN>"
```

**Expected Response** (200 OK):
```json
{
  "message": "Hello, johndoe! You have USER access."
}
```

### 4. Access Admin-Only Endpoint (Expect 403)

```bash
curl http://localhost:8080/api/protected/admin \
  -H "Authorization: Bearer <ACCESS_TOKEN>"
```

**Expected Response** (403 Forbidden):
```json
{
  "error": "ACCESS_DENIED",
  "message": "Access denied",
  "timestamp": "2026-01-05T10:35:00Z"
}
```

### 5. Refresh Token

```bash
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refreshToken": "<REFRESH_TOKEN>"
  }'
```

**Expected Response** (200 OK):
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "bmV3IHJlZnJlc2ggdG9rZW4...",
  "tokenType": "Bearer",
  "expiresIn": 900
}
```

### 6. Logout

```bash
curl -X POST http://localhost:8080/api/auth/logout \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "refreshToken": "<REFRESH_TOKEN>"
  }'
```

**Expected Response** (200 OK):
```json
{
  "message": "Logged out successfully"
}
```

After logout, the refresh token is invalidated:

```bash
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refreshToken": "<REFRESH_TOKEN>"
  }'
```

**Expected Response** (401 Unauthorized):
```json
{
  "error": "INVALID_TOKEN",
  "message": "Invalid or expired refresh token",
  "timestamp": "2026-01-05T10:40:00Z"
}
```

## Configuration

JWT settings are configured in `auth-demo-bootstrap/src/main/resources/application.yml`:

```yaml
jwt:
  secret: ${JWT_SECRET:default-dev-secret-change-in-production}
  access-token-expiration: 900000    # 15 minutes
  refresh-token-expiration: 604800000 # 7 days
```

**Production**: Set `JWT_SECRET` environment variable with a secure random string (256+ bits).

## Adding Protected Endpoints

Use Spring Security annotations to protect your endpoints:

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {

    // Accessible to any authenticated user
    @GetMapping
    public List<Order> listOrders() {
        // ...
    }

    // Accessible only to ADMIN role
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public void deleteOrder(@PathVariable UUID id) {
        // ...
    }
}
```

## Common Issues

### "401 Unauthorized" on all requests

- Check that the `Authorization` header format is correct: `Bearer <token>` (with space)
- Verify the token hasn't expired (15 min default)
- Ensure the JWT secret matches between token creation and validation

### "403 Forbidden" when expecting access

- Check user roles (default is USER only)
- Verify the endpoint's `@PreAuthorize` annotation matches user's roles

### Token expiration too fast for testing

Temporarily increase expiration in `application.yml`:

```yaml
jwt:
  access-token-expiration: 3600000  # 1 hour for testing
```

## Next Steps

- Review `SecurityConfig.java` in the infrastructure module
- Add custom roles as needed
- Implement password reset functionality
- Add email verification for registration
